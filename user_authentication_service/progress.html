<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Test Dashboard — Pytest & Unittest</title>
<style>
  :root{
    --bg:#070a14; --bg-2:#0b1226; --card:#0f1831; --card-2:#0c142a;
    --muted:#8ca2c0; --text:#e9eef8; --pill:#0f2147; --pill-2:#122a57;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --info:#22d3ee;
    --grad:linear-gradient(90deg,#6366f1,#22d3ee);
    --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 700px at 20% -10%, #141b31 0%, transparent 60%),
      radial-gradient(900px 500px at 100% 0%, #0d1c3a 0%, transparent 60%),
      var(--bg);
    color:var(--text);
    font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  }
  .layout{
    display:grid; grid-template-columns: 270px 1fr; gap:16px; padding:18px; min-height:100%;
  }
  /* Sidebar */
  .side{
    background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 30%),var(--card);
    border:1px solid var(--border); border-radius:14px; padding:16px; position:sticky; top:18px; height:max-content;
  }
  .brand{
    display:flex; align-items:center; gap:10px; margin-bottom:18px;
    font-weight:800; letter-spacing:.2px
  }
  .brand svg{filter:drop-shadow(0 6px 16px rgba(34,211,238,.25))}
  .tabs{display:flex; flex-direction:column; gap:8px}
  .tab{
    padding:10px 12px; border-radius:10px; background:var(--pill);
    border:1px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .tab.active{background:var(--pill-2); outline:1px solid rgba(99,102,241,.35)}
  .tab small{color:var(--muted)}
  .group{
    margin-top:16px; padding-top:16px; border-top:1px dashed var(--border);
  }
  .group h4{margin:0 0 8px 0; font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted)}
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--pill); border:1px solid var(--border); color:var(--muted); margin-right:6px; margin-bottom:6px; cursor:pointer;
  }
  .chip.active{background:#102a4b; color:#bcd7ff; outline:1px solid rgba(160,200,255,.25)}
  .run{
    margin-top:14px; width:100%; padding:12px 14px; border-radius:12px; border:0; background:var(--grad); color:#041322; font-weight:800; cursor:pointer;
    box-shadow:0 12px 30px rgba(34,211,238,.18); transition:transform .12s ease,opacity .2s ease;
  }
  .run:active{transform:translateY(1px)}
  .run[disabled]{opacity:.6; cursor:not-allowed}

  /* Main */
  .main{
    display:grid; grid-template-rows:auto auto 1fr; gap:14px;
  }
  .kpis{
    display:grid; grid-template-columns: repeat(4, minmax(170px, 1fr)); gap:12px;
  }
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.035),transparent 40%),var(--card-2);
    border:1px solid var(--border); border-radius:14px; padding:14px;
    box-shadow:0 14px 44px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
  }
  .kpi{display:flex; align-items:center; justify-content:space-between}
  .kpi h3{margin:0; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase}
  .kpi strong{font-size:24px}
  .kpi .ok{color:var(--ok)} .kpi .warn{color:var(--warn)} .kpi .err{color:var(--err)} .kpi .info{color:var(--info)}

  .progress{height:16px; border-radius:999px; background:#0c1630; border:1px solid var(--border); overflow:hidden}
  .bar{height:100%; width:0%; background:var(--grad); box-shadow:0 10px 24px rgba(99,102,241,.18); transition:width .35s cubic-bezier(.4,0,.2,1)}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .toolbar .toggle{padding:8px 12px; border-radius:10px; background:var(--pill); border:1px solid var(--border); color:var(--muted); cursor:pointer}
  .toggle.active{background:var(--pill-2); color:#cfe4ff}

  .grid{
    display:grid; grid-template-columns: 1.25fr .75fr; gap:12px; min-height:520px;
  }
  .panel{display:flex; flex-direction:column; min-height:320px}
  .panel h2{margin:0 0 10px 0; font-size:16px}
  .list{flex:1; overflow:auto; border:1px solid var(--border); border-radius:12px; background:#0c1427}
  .list-details{display:none; border-top:1px dashed rgba(255,255,255,.06)}
  .list-details.open{display:block}
  .row{display:grid; grid-template-columns: 1fr 90px 90px 70px; gap:10px; padding:10px 12px; border-bottom:1px dashed rgba(255,255,255,.06); align-items:center}
  .row.head{position:sticky; top:0; background:#101a34; border-bottom:1px solid var(--border); font-weight:700}
  .status{display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
  .status.ok{background:rgba(16,185,129,.08); color:#b6f3dc; border-color:rgba(16,185,129,.25)}
  .status.err{background:rgba(239,68,68,.08); color:#ffd0d0; border-color:rgba(239,68,68,.25)}
  .status.skip{background:rgba(245,158,11,.08); color:#ffe0b3; border-color:rgba(245,158,11,.25)}

  .logs{height:100%; overflow:auto; padding:12px; border:1px solid var(--border); border-radius:12px; background:#0c1427; color:#c9d3e7; font-family:ui-monospace,Menlo,Consolas,monospace}
  .log-line{white-space:pre-wrap; margin:0 0 6px}
  .muted{color:var(--muted)}
  .footer{margin-top:8px; display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}
  @media (max-width: 1080px){
    .layout{grid-template-columns: 1fr}
    .grid{grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="side">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h10a2 2 0 0 1 2 2v9.5a2 2 0 0 1-.67 1.49l-5 4.5a2 2 0 0 1-2.66 0l-5-4.5A2 2 0 0 1 5 14.5V5a2 2 0 0 1 2-2Z" stroke="#7aa2ff" stroke-width="1.2"/></svg>
        <div>Test Dashboard</div>
      </div>

      <div class="tabs" id="suiteTabs">
        <div class="tab active" data-suite="pytest"><span>Pytest</span><small id="badgePytest">—</small></div>
        <div class="tab" data-suite="unittest"><span>Unittest</span><small id="badgeUnit">—</small></div>
        <div class="tab" data-suite="all"><span>Tous (mix)</span><small id="badgeAll">—</small></div>
      </div>

      <div class="group">
        <h4>Filtres rapides</h4>
        <div id="chips">
          <span class="chip active" data-filter="all">Tout</span>
          <span class="chip" data-filter="passed">Pass</span>
          <span class="chip" data-filter="failed">Fail/Err</span>
          <span class="chip" data-filter="skipped">Skip/X</span>
        </div>
      </div>

      <button class="run" id="runBtn">Lancer les tests</button>
      <div class="footer"><span>Backend: <span class="muted">/run · /events (SSE)</span></span></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- KPIs -->
      <section class="kpis">
        <div class="card kpi"><h3>Total</h3><strong class="info" id="kTotal">0</strong></div>
        <div class="card kpi"><h3>Pass</h3><strong class="ok" id="kPass">0</strong></div>
        <div class="card kpi"><h3>Skip/X</h3><strong class="warn" id="kSkip">0</strong></div>
        <div class="card kpi"><h3>Fail/Err</h3><strong class="err" id="kFail">0</strong></div>
      </section>

      <!-- Progress + view toggles -->
      <section class="card">
        <div class="toolbar" style="margin-bottom:10px;">
          <div style="flex:1; color:var(--muted)">Progression globale</div>
          <button class="toggle active" id="tGrouped">Groupé</button>
          <button class="toggle" id="tFlat">Individuel</button>
          <button class="toggle" id="tAutoScroll">Auto-scroll logs</button>
        </div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="bar" id="bar"></div>
        </div>
        <div class="footer">
          <div id="percent">0%</div>
          <div id="statusLine">Prêt</div>
        </div>
      </section>

      <!-- Lists + Logs -->
      <section class="grid">
        <div class="panel card">
          <h2 id="listTitle">Tests (groupés par fichier/classe)</h2>
          <div class="list" id="list">
            <div class="row head"><div>Nom</div><div>Durée</div><div>Statut</div><div>%</div></div>
            <!-- rows injected -->
          </div>
          <div class="footer"><span id="hint">Astuce : clique une ligne pour dérouler les tests.</span><span class="muted" id="runtime">—</span></div>
        </div>
        <div class="panel card">
          <h2>Logs en direct</h2>
          <div class="logs" id="logs" aria-live="polite" aria-atomic="false"></div>
          <div class="footer">
            <span id="logHint">⏳ En attente…</span>
            <a href="#" id="clearLogs" class="muted">Effacer</a>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // Elements
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const bar = $('#bar'), percent = $('#percent'), statusLine = $('#statusLine');
  const kTotal=$('#kTotal'), kPass=$('#kPass'), kSkip=$('#kSkip'), kFail=$('#kFail');
  const list = $('#list'), logs = $('#logs'), runtime = $('#runtime');
  const tGrouped = $('#tGrouped'), tFlat = $('#tFlat'), tAutoScroll = $('#tAutoScroll');
  const runBtn = $('#runBtn'), clearLogs = $('#clearLogs'), listTitle = $('#listTitle');
  const suiteTabs = $('#suiteTabs');

  // State
  let es=null, filter='all', suite='pytest', grouped=true, autoScroll=false;
  let totals={total:0, passed:0, failed:0, skipped:0, done:0};
  let startedAt=null;
  let plannedTotal = 0;
  // storage for nodes
  const groups=new Map(); // key=file_or_class -> {node, items:[]}
  const flat=[];

  function fmt(ms){
    if (!ms) return '—';
    const s=ms/1000; return s<1 ? `${ms|0}ms` : `${s.toFixed(2)}s`;
  }

  function setProgress(v){
    v = Math.max(0, Math.min(100, v));
    bar.style.width = v + '%';
    bar.parentElement.setAttribute('aria-valuenow', String(v|0));
    percent.textContent = v.toFixed(0) + '%';
  }

  function log(line, dim=false){
    const div=document.createElement('div');
    div.className='log-line'+(dim?' muted':'');
    div.textContent=line;
    logs.appendChild(div);
    if (autoScroll) logs.scrollTop=logs.scrollHeight;
  }

  function resetUI(){
    totals={total:0, passed:0, failed:0, skipped:0, done:0};
    plannedTotal = 0;
    groups.clear(); flat.length=0;
    list.innerHTML = '<div class="row head"><div>Nom</div><div>Durée</div><div>Statut</div><div>%</div></div>';
    logs.innerHTML='';
    setProgress(0);
    kTotal.textContent=kPass.textContent=kSkip.textContent=kFail.textContent='0';
    percent.textContent='0%'; statusLine.textContent='Prêt'; runtime.textContent='—';
  }

  function ensureGroup(key){
    if (groups.has(key)) return groups.get(key);

    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div style="font-weight:600">${key}</div>
      <div class="muted" data-k="dur">—</div>
      <div><span class="status" data-k="st">—</span></div>
      <div class="muted" data-k="pct">0%</div>
    `;

    const details = document.createElement('div');
    details.className = 'list-details';

    row.addEventListener('click', () => {
      details.classList.toggle('open');
    });

    list.appendChild(row);
    list.appendChild(details);

    const g = { row, details, items:[], dur:0, passed:0, failed:0, skipped:0, total:0 };
    groups.set(key, g);
    return g;
  }


  function paintGroup(g){
    const pct = g.total ? (g.passed / g.total * 100) : 0;
    g.row.querySelector('[data-k="pct"]').textContent = pct.toFixed(0)+'%';
    g.row.querySelector('[data-k="dur"]').textContent = fmt(g.dur);
    const st=g.row.querySelector('[data-k="st"]');
    st.className='status '+(g.failed? 'err' : (g.skipped? 'skip' : 'ok'));
    st.textContent = g.failed? 'Fail' : (g.skipped? 'Skip' : 'Pass');
  }

  function addCase(nodeid, outcome, duration_ms){
    // nodeid format pytest: file::Class::test_name
    const parts = nodeid.split('::');
    const groupKey = grouped ? (parts[0] + (parts.length>2 ? '::'+parts[1] : '')) : '__flat__';
    const g = ensureGroup(groupKey);

    const item=document.createElement('div');
    item.className='row';
    item.dataset.outcome=outcome;
    const name = grouped ? parts.slice(2).join('::') || '(module)' : nodeid;
    item.innerHTML=`<div>${name}</div>
                    <div class="muted">${fmt(duration_ms)}</div>
                    <div><span class="status ${outcome==='passed'?'ok': outcome==='failed'?'err':'skip'}">${outcome.replace('_',' ')}</span></div>
                    <div class="muted"></div>`;
    g.details.appendChild(item);
    g.items.push(item);
    g.total++; g.dur += (duration_ms||0);
    if (outcome==='passed') g.passed++; else if (outcome==='failed' || outcome==='error') g.failed++; else g.skipped++;
    paintGroup(g);

    // Flat view storage
    flat.push({nodeid, duration_ms, outcome});
  }

  function applyFilter(){
    const f=filter;
    $$('.row', list).forEach(r=>{
      if (r.classList.contains('head')) return;
      if (!r.parentElement.classList.contains('list-details')) return; // only items
      const oc = r.querySelector('.status')?.className || '';
      const show = (f==='all') ||
                   (f==='passed' && oc.includes('ok')) ||
                   (f==='failed' && oc.includes('err')) ||
                   (f==='skipped' && oc.includes('skip'));
      r.style.display = show ? '' : 'none';
    });
  }

  function renderFlat(){
    listTitle.textContent='Tests (liste individuelle)';
    list.innerHTML = '<div class="row head"><div>Test</div><div>Durée</div><div>Statut</div><div></div></div>';
    flat.forEach(({nodeid, duration_ms, outcome})=>{
      const r=document.createElement('div');
      r.className='row';
      r.innerHTML=`<div>${nodeid}</div>
                   <div class="muted">${fmt(duration_ms)}</div>
                   <div><span class="status ${outcome==='passed'?'ok': outcome==='failed'?'err':'skip'}">${outcome.replace('_',' ')}</span></div>
                   <div></div>`;
      list.appendChild(r);
    });
    applyFilter();
  }

  function parseParts(nodeid){
  // pytest: "file::Class::test_name" (Class optionnelle)
  const parts = nodeid.split('::');
  const file = parts[0] || '';
  const cls  = parts.length > 2 ? parts[1] : '';
  const name = parts.slice(2).join('::') || '(module)';
  return { file, cls, name };
}


  function renderGrouped(){
    listTitle.textContent='Tests (groupés par fichier/classe)';
    list.innerHTML = '<div class="row head"><div>Nom</div><div>Durée</div><div>Statut</div><div>%</div></div>';

    // Regrouper depuis flat[]
    const map = new Map();
    for (const { nodeid, duration_ms, outcome } of flat){
      const { file, cls, name } = parseParts(nodeid);
      const key = cls ? `${file}::${cls}` : file;
      if (!map.has(key)){
        map.set(key, { dur:0, passed:0, failed:0, skipped:0, total:0, items:[] });
      }
      const g = map.get(key);
      g.total += 1;
      g.dur += (duration_ms || 0);
      if (outcome === 'passed') g.passed += 1;
      else if (outcome === 'failed' || outcome === 'error') g.failed += 1;
      else g.skipped += 1;
      g.items.push({ name, duration_ms, outcome });
    }

  // Construire le DOM
  for (const [key, g] of map.entries()){
    const row = document.createElement('div');
    row.className = 'row';
    const pct = g.total ? (g.passed / g.total * 100) : 0;
    const st  = g.failed ? 'err' : (g.skipped ? 'skip' : 'ok');
    const stText = g.failed ? 'Fail' : (g.skipped ? 'Skip' : 'Pass');

    row.innerHTML = `
      <div style="font-weight:600">${key}</div>
      <div class="muted">${fmt(g.dur)}</div>
      <div><span class="status ${st}">${stText}</span></div>
      <div class="muted">${pct.toFixed(0)}%</div>
    `;

    const details = document.createElement('div');
    details.className = 'list-details';

    row.addEventListener('click', () => details.classList.toggle('open'));

    for (const it of g.items){
      const r = document.createElement('div');
      r.className = 'row';
      r.dataset.outcome = it.outcome;
      r.innerHTML = `
        <div>${it.name}</div>
        <div class="muted">${fmt(it.duration_ms)}</div>
        <div><span class="status ${it.outcome==='passed'?'ok': it.outcome==='failed'?'err':'skip'}">${it.outcome.replace('_',' ')}</span></div>
        <div class="muted"></div>
      `;
      details.appendChild(r);
    }

    list.appendChild(row);
    list.appendChild(details);
  }

  applyFilter();
}


  function connectSSE(){
    if (es) es.close();
    const url = `/events?suite=${encodeURIComponent(suite)}`;
    es = new EventSource(url);
    log(`✅ Connexion SSE: ${url}`, true);

    es.addEventListener('open', ()=> log('Flux SSE démarré', true));

    es.addEventListener('init', e=>{
      const d = JSON.parse(e.data);
      log(`[INIT] total=${d.total}`, true);
    plannedTotal = d.total || 0;
    totals.total = plannedTotal;
    kTotal.textContent = plannedTotal || '—';
    statusLine.textContent = 'Collecte…';
    startedAt = Date.now();
    });

    es.addEventListener('case', e=>{
      const d = JSON.parse(e.data);
      statusLine.textContent = d.nodeid || '';
      log(`🧪 ${d.nodeid}`, true);
    });

    es.addEventListener('result', e=>{
      const d = JSON.parse(e.data); // {nodeid, outcome, duration_ms}
      addCase(d.nodeid, d.outcome, d.duration_ms||0);
      statusLine.textContent = `${d.nodeid} — ${d.outcome.toUpperCase()}`;
    });

    es.addEventListener('update', e=>{
      const d = JSON.parse(e.data);
      log(`[UPDATE] ${e.data}`, true);
      Object.assign(totals, d);

      // ✅ N'utiliser que 'init' (totals.total) ou 'd.total' s'il est fourni.
      const knownTotal = (totals.total && totals.total > 0)
        ? totals.total
        : (d.total && d.total > 0 ? d.total : 0);

      const safeDone = (typeof totals.done === 'number')
        ? totals.done
        : ((totals.passed||0) + (totals.failed||0) + (totals.skipped||0));

      if (knownTotal > 0) {
        kTotal.textContent = knownTotal;
        const pct = (safeDone / knownTotal) * 100;
        setProgress(pct);
      } else {
        // Total inconnu (init pas encore reçu) → rester à 0%
        kTotal.textContent = '—';
        setProgress(0);
      }

      kPass.textContent = totals.passed||0;
      kFail.textContent = totals.failed||0;
      kSkip.textContent = totals.skipped||0;

      if (grouped) renderGrouped(); else renderFlat();
    });


    es.addEventListener('end', e=>{
      const d = JSON.parse(e.data);
      log(`[END] ${e.data}`, true);

      totals.total   = d.total || totals.total || flat.length || 0;
      totals.passed  = d.passed;
      totals.failed  = d.failed;
      totals.skipped = d.skipped;

      kTotal.textContent = totals.total;
      kPass.textContent  = totals.passed;
      kFail.textContent  = totals.failed;
      kSkip.textContent  = totals.skipped;

      setProgress(100);
      statusLine.textContent = `Terminé: ${d.passed} pass, ${d.failed} fail/err, ${d.skipped} skip/x.`;

      const ms = Date.now() - (startedAt || Date.now());
      runtime.textContent = `Durée totale: ${fmt(ms)}`;
      runBtn.disabled = false;

      if (grouped) renderGrouped(); else renderFlat();
    });

    es.addEventListener('error', ()=>{
      log('❌ Flux SSE coupé.', true);
      runBtn.disabled = false;
    });
  }


  // Actions
  runBtn.addEventListener('click', async ()=>{
    runBtn.disabled = true;
    resetUI();
    connectSSE();
    log(`▶️ Lancement de ${suite.toUpperCase()}…`);
    try{
      await fetch(`/run?suite=${encodeURIComponent(suite)}`, {method:'POST'});
    }catch{
      log('❌ Appel /run échoué (backend indisponible).');
      runBtn.disabled=false;
    }
  });

  clearLogs.addEventListener('click', e=>{e.preventDefault(); logs.innerHTML='';});

  // Filters
  $$('#chips .chip').forEach(c=>{
    c.addEventListener('click', ()=>{
      $$('#chips .chip').forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); filter=c.dataset.filter; applyFilter();
    });
  });

  // View toggles
  function setGrouped(v){
    grouped = v;
    tGrouped.classList.toggle('active', grouped);
    tFlat.classList.toggle('active', !grouped);
    if (grouped) renderGrouped(); else renderFlat();
  }
  tGrouped.addEventListener('click', ()=> setGrouped(true));
  tFlat.addEventListener('click', ()=> setGrouped(false));
  tAutoScroll.addEventListener('click', ()=>{
    autoScroll=!autoScroll;
    tAutoScroll.classList.toggle('active', autoScroll);
    if (autoScroll) logs.scrollTop = logs.scrollHeight;
  });


  // Suite tabs
  $$('.tab', suiteTabs).forEach(t=>{
    t.addEventListener('click', ()=>{
      $$('.tab', suiteTabs).forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      suite = t.dataset.suite;
      log(`📦 Suite sélectionnée: ${suite}`);
    });
  });

  // First load
  resetUI();
})();
</script>
</body>
</html>
